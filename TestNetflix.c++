// --------------------------------
// projects/collatz/TestCollatz.c++
// Copyright (C) 2016
// Glenn P. Downing
// --------------------------------

// https://code.google.com/p/googletest/wiki/V1_7_Primer#Basic_Assertions

// --------
// includes
// --------

#include <iostream> // cout, endl
#include <map>      // map
#include <sstream>  // istringtstream, ostringstream
#include <string>   // string
#include <utility>  // pair

#include "gtest/gtest.h"

#include "Netflix.h"

using namespace std;

// ----
// build_user_averages_cache
// ----
TEST(NetflixFixture, read_user_averages_cache) {
  map<int, double> user_averages;
  build_user_averages_cache(user_averages);
  ASSERT_EQ(user_averages[28500], 4);
  ASSERT_EQ(user_averages[1805261], 2.5);
  ASSERT_EQ(user_averages[2029573], 2);
}

// ----
// build_user_sds_cache
// ----
TEST(NetflixFixture, build_user_sds_cache) {
  map<int, double> user_sds;
  build_user_sds_cache(user_sds);
  ASSERT_EQ(user_sds[28800], 1);
  ASSERT_EQ(user_sds[1905528], 0.983956);
  ASSERT_EQ(user_sds[1977928], 0);
}

// ----
// build_movie_norm_ratings_cache
// ----
TEST(NetflixFixture, read_movie_norm_ratings_cache) {
  map<int, double> movie_norm_ratings;
  build_movie_norm_ratings_cache(movie_norm_ratings);
  ASSERT_EQ(movie_norm_ratings[10014], -0.146618);
  ASSERT_EQ(movie_norm_ratings[13186], 0.135852);
  ASSERT_EQ(movie_norm_ratings[9999], -1.19832);
}

// ----
// predict
// ----
istringstream r(
    "13764:"
    "\n1608452\n1314512\n1377018\n1937794\n2424903\n2134424\n1714054\n514892\n1"
    "058317\n2524907\n1177848\n1996784\n2413874\n1240846\n13765:"
    "\n1331175\n1518071\n2303558\n1381451\n2530047\n1353907\n795274\n1582786\n2"
    "358685\n152958\n2031648\n2062857\n1922937\n116334\n2642642\n1103874\n20781"
    "15\n1836344\n485462\n46650\n2377042\n594445\n1076842\n938623\n2107966\n971"
    "420\n956271\n1070896\n1985228\n1218907\n1474057\n559639\n628112\n2383986\n"
    "2639280\n13766:\n789846\n13797:\n301908\n257517\n265275\n13798:"
    "\n1278153\n673263\n2587481\n545812\n1470248\n978936\n1812802\n481710\n1375"
    "578\n978176\n1240814\n1468766\n1179115\n576444\n2464841\n2268233\n99750\n6"
    "86493\n1595569\n1563705\n2052551\n1893401\n2581260\n1458835\n322810\n29111"
    "\n1763411\n1802691\n206116\n1116301\n2022608\n1444819\n283650\n1326390\n22"
    "33756\n2051140\n295059\n1287721\n1131548\n668632\n2129609\n2200724\n216710"
    "5\n969003\n472169\n1110421\n988041\n811476\n787828\n28172\n1508976\n224463"
    "9\n343983\n1633625\n1116930\n2363926\n2392799\n2618095\n181207\n2136859\n1"
    "451353\n1638324\n872735\n1574582\n2346644\n738747\n1480223\n2583515\n80516"
    "1\n834982\n2404731\n2637383\n829594\n2166702\n765465\n2271950\n117346\n430"
    "890\n1944846\n323748\n1298331\n575293\n2482428\n760579\n2402914\n578627\n5"
    "54324\n939686\n1457006\n14450\n2503339\n2114834\n1974894\n2625634\n1944012"
    "\n2239213\n392448\n633791\n1344094\n449543\n1449241\n1330322\n638657\n2498"
    "939\n2546087\n2179686\n1287793\n15955\n346924\n127884\n885875\n44288\n1900"
    "241\n2092912\n1372472\n1389412\n1752572\n1667925\n2446923\n2214211\n113086"
    "3\n1058399\n1063747\n1533530\n1824854\n670464\n1181364\n1772380\n218390\n1"
    "753633\n2427806\n1073670\n1587343\n1495806\n1054248\n438836\n13799:"
    "\n1105698\n138:"
    "\n1735266\n1270280\n164176\n2149638\n2588709\n2030896\n1131834\n334813\n72"
    "7480\n1998055\n2350646\n162556\n1045972\n2329942\n69353\n2188348\n1720458"
    "\n2175000\n2345785\n2510690\n969604\n2175004\n1792849\n452106\n2205464\n45"
    "9857\n1731269\n1309115\n2594867\n1116748\n744667\n2048260\n508815\n1004682"
    "\n2497533\n1758753\n1996705\n1888734\n725694\n1525878\n1558904\n504211\n11"
    "85265\n1839403\n1850615\n403379\n846705\n299243\n679631\n2574884\n1988840"
    "\n1421121\n1345829\n1851595\n2391073\n2615916\n720975\n1816320\n601468\n29"
    "892\n680845\n192949\n685076\n1218599\n1369931\n2113548\n470613\n1276137\n2"
    "463044\n530187\n2117250\n2578919\n2256493\n892349\n1041160\n2634974\n13333"
    "10\n1529147\n116699\n2515886\n566580\n1331224\n1200783\n1539258\n345569\n1"
    "987735\n2406761\n1914623\n2521437\n2637257\n329288\n705605\n2629314\n12653"
    "8\n789387\n1718775\n821222\n2296989\n210296\n2352289\n1205382\n2158839\n22"
    "41873\n716761\n1884888\n1558888\n629801\n2541517\n2313884\n2180924\n128418"
    "6\n2240611\n667364\n1085864\n1749662\n2239922\n899195\n72046\n188107\n1273"
    "002\n502509\n349187\n1735986\n1522497\n130488\n1268783\n681782\n839620\n84"
    "1973\n1817237\n2058273\n2024051\n701752\n113142\n1700614\n482115\n1837794"
    "\n1748443\n622919\n371483\n1365046\n8991\n1415955\n919123\n2186038\n256442"
    "8\n2047981\n235480\n1015672\n1203347\n2041222\n131184\n293708\n2404702\n11"
    "38575\n671828\n2092512\n2351387\n1057337\n1311584\n2593371\n1688134\n14097"
    "98\n992975\n2301847\n1210485\n554292\n1179290\n1767452\n390490\n1149049\n1"
    "911710\n951873\n157527\n1649949\n1247398\n765740\n1418405\n2328849\n257300"
    "6\n2611698\n829305\n821315\n2422017\n383274\n1879011\n413882\n944614\n1340"
    "424\n1647050\n1408655\n1586383\n2342649\n1765552\n1617382\n1678882\n505022"
    "\n1497013\n2330526\n561487\n638016\n59397\n2448547\n1454284\n831572\n19491"
    "83\n129008\n1775818\n1842917\n2182280\n407576\n1247593\n191277\n74020\n437"
    "742\n701112\n2425600\n2589079\n1716933\n2552572\n2259646\n200975\n1777003"
    "\n1815342\n1510468\n1380:\n804004\n2369086\n1564887\n2008336\n13800:"
    "\n2232104\n802351\n1905504\n593253\n13801:"
    "\n1534686\n2049949\n1816571\n2156263\n1329185\n188268\n2135429\n972824\n15"
    "50950\n2564970\n603793\n1728002\n1297764\n671089\n1352662\n2211342\n708967"
    "\n13802:\n2337382\n2060291\n61624\n2008336\n13803:"
    "\n2084572\n2565504\n1771252\n1048289\n223959\n860775\n2065019\n1154641\n76"
    "5167\n1392742\n414258\n1310974\n1586383\n13804:"
    "\n2496849\n1510766\n1089888\n907026\n1553635\n13805:"
    "\n468572\n1408352\n2199415\n1000546\n1448808\n1781836\n2013650\n1658930\n6"
    "90763\n1966998\n972817\n1915183\n1165572\n279222\n34599\n1108109\n1108236"
    "\n459321\n2062706\n819880\n1912109\n2119994\n1212537\n1612920\n826920\n178"
    "3762\n1428523\n1018245\n316053\n1985232\n443508\n1653932\n359853\n345805\n"
    "2047279\n13806:"
    "\n2393743\n376508\n2485616\n2147650\n1599977\n1238388\n1936750\n599328\n21"
    "19724\n124145\n2525827\n1972439\n465247\n578164\n2607880\n186244\n414243\n"
    "630924\n2244376\n226282\n818154\n681830\n1173626\n1630771\n38998\n2544305"
    "\n1975192\n2189209\n1109353\n1013913\n2489068\n2306758\n1072774\n521611\n3"
    "24784\n1456650\n818926\n1273709\n408840\n1709037\n2315626\n2173286\n133371"
    "1\n2314134\n2267460\n426406\n1732101\n2553781\n666250\n733559\n2113433\n25"
    "56654\n961751\n1155815\n2252227\n173152\n1397183\n1968070\n1617185\n119684"
    "5\n1524862\n13808:"
    "\n2224881\n357521\n2348376\n2147741\n982771\n2518523\n306781\n1395040\n234"
    "070\n833763\n2383611\n2117443\n928878\n1300256\n404701\n666065\n2163226\n6"
    "92268\n969542\n936494\n1150965\n2092933\n2059984\n1751053\n2044291\n133664"
    "9\n2488810\n1097782\n1179165\n1918229\n509231\n2532280\n751639\n1955470\n4"
    "5560\n2494404\n1852053\n845009\n148605\n1820288\n2072734\n819192\n1003019"
    "\n1568796\n2602339\n8374:\n1184606\n980990\n8375:"
    "\n1400206\n2610959\n922327\n2627705\n252987\n800667\n2151581\n1325572\n561"
    "419\n1831282\n1310111\n1203046\n8376:"
    "\n672200\n1341330\n1816366\n2233838\n1413196\n686007\n546130\n1967061\n140"
    "7898\n1896247\n2230367\n2042048\n1576428\n1513409\n2601260\n2413832\n74221"
    "9\n2608552\n1467874\n754344\n798636\n2079465\n2211521\n2378309\n915206\n15"
    "93430\n1653157\n1131364\n1769012\n2514482\n286581\n1398236\n1319967\n25362"
    "32\n1125832\n687311\n1529950\n863672\n366380\n53039\n636812\n271825\n50106"
    "0\n1483403\n1494634\n2284205\n2190277\n2246729\n963277\n845791\n946513\n21"
    "70201\n1349706\n716650\n153486\n411286\n2043085\n1418538\n2170563\n2460765"
    "\n2445468\n1875277\n1580859\n1715050\n1466372\n1851895\n987647\n2166574\n1"
    "093558\n278650\n1278022\n1990874\n2294787\n586491\n70796\n1724325\n773429"
    "\n6154\n1877609\n1625484\n989162\n2528840\n2050117\n1597302\n1094664\n2234"
    "074\n572975\n2629083\n2333987\n1574572\n86817\n1745819\n2224656\n1188824\n"
    "931772\n978813\n1649650\n866820\n2505235\n494646\n428059\n567057\n551549\n"
    "2623559\n2562638\n2173533\n2394322\n1232615\n2590958\n2572558\n1951475\n18"
    "84514\n1512869\n1433794\n813658\n2298042\n546378\n17957\n2470122\n938982\n"
    "976463\n2315923\n1939780\n1950956\n854283\n1583337\n1742035\n173220\n21305"
    "96\n1709349\n760702\n1192062\n1839381\n806166\n1485047\n2138829\n1150369\n"
    "265878\n1723450\n475289\n902129\n1008688\n1638932\n1245168\n1508370\n10799"
    "43\n2026790\n1493473\n1181134\n2521224\n2481025\n380649\n911635\n2606497\n"
    "2133414\n778920\n1826151\n2481828\n197143\n1643964\n392919\n8458\n2140012"
    "\n661730\n2091841\n1859930\n470190\n2600702\n167884\n1105650\n2153069\n168"
    "1466\n886899\n2163774\n1471776\n2179194\n2166271\n187364\n1138452\n911211"
    "\n864927\n2326111\n1136201\n1310630\n1077124\n740920\n1728895\n1032909\n22"
    "93524\n429063\n2269445\n1205633\n591708\n1168889\n1852311\n1586184\n250765"
    "3\n2294113\n1759659\n726372\n1304316\n702748\n230673\n174908\n2547321\n150"
    "3578\n529224\n1785522\n1696064\n2008776\n1902937\n2310496\n2141427\n234410"
    "4\n2553592\n899468\n1064497\n1066085\n2150004\n381001\n2076387\n1164130\n7"
    "33891\n358392\n2041094\n2265772\n1283117\n60668\n2649136\n1563782\n622617"
    "\n1750621\n958163\n2226203\n946904\n30241\n224647\n605116\n2151176\n884748"
    "\n792112\n2320382\n351636\n2218517\n2108197\n204380\n91627\n1531417\n18166"
    "22\n1638715\n319266\n2353857\n243751\n1885251\n1486588\n2453684\n2292398\n"
    "1961176\n655025\n1723704\n2203987\n388192\n1819260\n471510\n152108\n753532"
    "\n2425418\n782511\n2414106\n2070009\n1800068\n2306848\n159266\n1473620\n16"
    "06319\n851373\n2084565\n1910274\n2596817\n1371337\n1093417\n1512706\n84670"
    "7\n965255\n286360\n1688068\n769545\n304045\n2017345\n2093727\n2039203\n269"
    "857\n1548379\n197287\n2176326\n69212\n359279\n413625\n1984686\n1342214\n15"
    "68289\n2242371\n2460943\n2017626\n808438\n2142262\n1873117\n2548273\n93057"
    "5\n715982\n830293\n41870\n1662281\n1042317\n1123410\n1533963\n244145\n8910"
    "93\n1016082\n105840\n1821623\n1470944\n1908581\n2221223\n664315\n447918\n5"
    "87674\n76880\n918586\n1017606\n2269428\n2419814\n1233593\n1497603\n646479"
    "\n866527\n2060682\n1092753\n1853960\n76119\n633442\n1032391\n2130879\n9443"
    "57\n1749191\n195132\n2245006\n766933\n207239\n2237919\n2010998\n923912\n22"
    "79435\n163901\n2399654\n1390607\n2122837\n106598\n1340552\n473807\n1760693"
    "\n2548411\n715466\n464626\n1419357\n2120512\n125011\n795340\n800552\n24425"
    "34\n261918\n2022748\n58140\n1553699\n839462\n507800\n926582\n667354\n21142"
    "23\n792264\n1649165\n2616516\n1187437\n1810106\n535747\n1955551\n2414958\n"
    "1787490\n3168\n1871136\n2531795\n2027634\n596142\n2075387\n2454587\n291182"
    "\n1405529\n150049\n1786918\n1515863\n689483\n1914382\n1786228\n493550\n118"
    "7735\n1059771\n725207\n815014\n1514040\n633740\n2183854\n1670526\n2577297"
    "\n1993351\n1930094\n1676563\n2313697\n1999169\n2034352\n414048\n1523435\n1"
    "102770\n571119\n2135285\n2090714\n1320687\n126646\n2312283\n1602127\n13954"
    "02\n6057\n944677\n252177\n403082\n802007\n2191636\n284470\n2130714\n123603"
    "8\n2614880\n846472\n593188\n2498230\n1121120\n2524139\n156019\n654729\n290"
    "248\n2246405\n267780\n1285118\n2418731\n2554991\n201491\n943561\n1708457\n"
    "116228\n1413803\n1342311\n748747\n2347849\n2155786\n763145\n1347831\n13660"
    "38\n2410440\n1881112\n1490334\n781417\n1665351\n2158824\n1716976\n452224\n"
    "1768969\n1687263\n2070942\n641739\n2502395\n1354827\n2117177\n613092\n1245"
    "67\n190763\n1529123\n100749\n424421\n1637888\n71540\n1894952\n1624257\n152"
    "134\n70109\n2311741\n1193160\n1616137\n1926685\n1676231\n2398437\n8385:"
    "\n2528078\n2517756\n224835\n2496475\n886905\n931565\n1728838\n2188860\n940"
    "50\n2556435\n1080147\n1276025\n8386:"
    "\n2587481\n638998\n722833\n841162\n2587732\n2250574\n1534393\n1450939\n138"
    "3671\n588373\n151300\n1367101\n1498793\n2335401\n1466742\n669790\n2484639"
    "\n1478134\n2111332\n1947134\n1634594\n380133\n1929834\n338115\n2224245\n23"
    "07289\n2345761\n1743319\n2410143\n2428225\n1355085\n1663002\n2501801\n2087"
    "880\n1088059\n224867\n1504146\n1057111\n166800\n1170770\n2240245\n1864332"
    "\n1611692\n8387:"
    "\n2105852\n1540073\n2066772\n1394510\n1468815\n298962\n2396153\n1812940\n1"
    "675150\n2044887\n1547800\n2384691\n773085\n2288343\n577383\n2633404\n10651"
    "72\n777522\n715598\n1722025\n1127238\n1700799\n386219\n1673647\n987339\n15"
    "12910\n1573674\n1741609\n182419\n2110807\n865725\n1343617\n372560\n122652"
    "\n219918\n1521664\n833326\n1989241\n2575825\n367549\n2073866\n691688\n2192"
    "484\n795454\n1604096\n1746380\n1218617\n1987734\n469001\n2470704\n2386551"
    "\n834815\n415695\n1026927\n307400\n428698\n2110273\n1553620\n2543645\n1821"
    "549\n2506541\n72995\n1009531\n1740273\n1443822\n524203\n1127887\n2449799\n"
    "980300\n1803381\n889425\n2627042\n2527287\n879312\n396951\n333139\n1669507"
    "\n759071\n2623870\n112513\n1066411\n1021446\n567286\n2262985\n2150657\n126"
    "1873\n1178420\n1008825\n492710\n1325959\n136991\n1550531\n2644217\n712295"
    "\n354704\n1051935\n1093447\n314968\n214296\n1917619\n2538851\n1921856\n453"
    "830\n2054867\n2351819\n2335191\n1920310\n875445\n1541447\n1309483\n669093"
    "\n1375789\n1670616\n1433511\n25813\n2350138\n575022\n2222181\n922134\n1417"
    "993\n269315\n848297\n1230511\n1347712\n2620321\n376323\n1866805\n2351891\n"
    "1864187\n459063\n647295\n73893\n1592421\n293031\n1200174\n2449719\n26524\n"
    "1979356\n2387476\n2627083\n1314271\n182574\n2207438\n1436842\n461164\n2711"
    "82\n1582786\n1231913\n2469598\n695\n1423853\n2377407\n1192903\n1342539\n21"
    "81000\n2030494\n1971931\n352116\n1472718\n286783\n1376756\n215616\n1378883"
    "\n1050735\n1603435\n303156\n875528\n966686\n1591050\n2264802\n1430624\n476"
    "184\n2396180\n2004639\n1275517\n420399\n311542\n2647159\n881287\n1757999\n"
    "887285\n2637639\n2622310\n1687896\n1467696\n167884\n1569929\n902996\n19101"
    "67\n1502867\n2039501\n190644\n2267391\n1487072\n1985643\n1570147\n1293463"
    "\n1463017\n473864\n2332105\n2496875\n846179");
ostringstream w;

double rmse = predict(r, w);

TEST(NetflixFixture, predict_rmse) { ASSERT_LT(rmse, 1); }

TEST(NetflixFixture, predict_stronger_eq) { ASSERT_EQ(rmse, 0.97); }